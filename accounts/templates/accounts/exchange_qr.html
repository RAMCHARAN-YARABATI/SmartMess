{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exchange QR</title>
    <link rel="stylesheet" href="{% static 'accounts/exchange_qr.css' %}">
</head>
<body>
    <nav>
     <a href="{% url 'home' %}">Home</a>
     <a href="{% url 'orders' %}">Orders</a>
     <a href="{% url 'exchange_qr' %}">Exchange QR</a>
     <a href="{% url 'special_orders' %}">Special Orders</a>
    </nav>

    <main class="main-content">
        <div class="container">
            <h1 class="page-title">Exchange Your Meal QR</h1>

            {% if messages %}
                <div class="message-container">
                    {% for message in messages %}
                        <div class="message-item {{ message.tags }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="form-section">
                {% if otp_sent_to_receiver %}
                    <h2 class="text-center text-xl font-semibold mb-4">Verify OTP to Complete Exchange</h2>
                    <p class="text-center text-gray-600 mb-4">An OTP has been sent to <span class="font-bold">{{ exchange_data_for_otp.receiver_email }}</span>. Please get the OTP from them and enter it below.</p>
                    <form method="post" class="text-center">
                        {% csrf_token %}
                        <input type="hidden" name="meal_type" value="{{ selected_meal_type_id }}">
                        <input type="hidden" name="exchange_date" value="{{ selected_exchange_date }}">
                        <input type="hidden" name="receiver_email" value="{{ selected_receiver_email }}">
                        
                        <div class="otp-input-group">
                            <input type="text" name="otp1" maxlength="1" class="otp-input" required autofocus>
                            <input type="text" name="otp2" maxlength="1" class="otp-input" required>
                            <input type="text" name="otp3" maxlength="1" class="otp-input" required>
                            <input type="text" name="otp4" maxlength="1" class="otp-input" required>
                        </div>
                        <p class="otp-info mt-4">OTP is valid for 5 minutes.</p>
                        <button type="submit" name="verify_otp" class="btn btn-verify-otp mt-4">Verify OTP & Exchange</button>
                    </form>
                {% else %}
                    <h2 class="text-center text-xl font-semibold mb-4">Initiate Meal Exchange</h2>
                    <p class="text-center text-gray-600 mb-6">If you have a booked meal you don't want, you can transfer it to another student.</p>
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="id_meal_type">Meal Type to Exchange:</label>
                            <select name="meal_type" id="id_meal_type" required>
                                <option value="">--- Select Meal ---</option>
                                {% for slot in meal_slots %}
                                    <option value="{{ slot.id }}" {% if selected_meal_type_id == slot.id|stringformat:"d" %}selected{% endif %}>{{ slot.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="id_exchange_date">Date of Meal:</label>
                            <input type="date" name="exchange_date" id="id_exchange_date" value="{{ selected_exchange_date }}" required>
                        </div>
                        <div class="form-group">
                            <label for="id_receiver_email">Receiver's Email (Student who will get the QR):</label>
                            <input type="email" name="receiver_email" id="id_receiver_email" value="{{ selected_receiver_email }}" placeholder="e.g., student@example.com" required>
                        </div>
                        <div class="text-center">
                            <button type="submit" name="login" class="btn btn-send-otp">Send OTP to Receiver</button>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const otpInputs = document.querySelectorAll('.otp-input');
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', function() {
                    if (this.value.length === this.maxLength && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                });

                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Backspace' && this.value.length === 0 && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
            });

            const exchangeDateInput = document.getElementById('id_exchange_date');
            if (exchangeDateInput) {
                const today = new Date();
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');
                exchangeDateInput.min = `${year}-${month}-${day}`;
            }
        });
    </script>
</body>
</html>